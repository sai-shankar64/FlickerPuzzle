var flickr={getThemeImage:function(e,t){var a,r=1;$.getJSON("https://www.flickr.com/photos/henrybrosius/16952077571/"),$.ajaxSetup({timeout:1e4}),$.getJSON("https://api.flickr.com/services/feeds/photos_public.gne?jsoncallback=?",{tags:e,tagmode:"any",format:"json"}).done(function(e){var t=Math.floor(Math.random()*e.items.length);a=e.items[t].media.m,a=a.replace(/_m/i,"_b"),$("#picture").attr("src",a);var i=e.items[t].description,n=/width=\"(\d+)\"/g,g=/height=\"(\d+)\"/g;try{var o=n.exec(i),d=parseInt(o[1]),m=g.exec(i),s=parseInt(m[1]);r=d/s}catch(e){r=1}}).fail(function(e,t,r){alert("failed to load image. Using default"),a="picture.svg"}).always(function(){void 0===a?(alert("could not fetch picture. Request timed out. Using default"),a="picture.svg"):game.changeImage(a,r,"pick a theme")})}},game={gridSize:3,default_img:"picture.svg",image_src:"picture.svg",image_aspect:1,reset:function(){$("#win").hide(),$("#grid").empty(),$("#gamebg").show(),$(".menu *").attr("disabled",!1),$("#timer").text("00:00:00")},setTheme:function(){$("#modal").show();var e=$(this).find(":selected").text();"pick a theme"===e?game.changeImage(default_img,1):flickr.getThemeImage(e,game.changeImage)},changeImage:function(e,t,a){game.image_src=e,game.image_aspect=t,$("#picture").attr("src",e).attr("title",a).load(function(){$("#modal").hide()})},begin:function(){timetracker.start(),$("#gamebg").hide(),$(".menu *").prop("disabled",!0),gameBoard.createGrid(game.image_aspect,game.image_src)},end:function(e){$("#verdict").html(e),$("#win").show()},updateLevel:function(){if(!timetracker.running){for(var e=$(this).attr("id"),t=1;t<5;t++){var a=$("#"+t);t<=e?(a.removeClass("fa-star-o"),a.addClass("fa-star")):(a.removeClass("fa-star"),a.addClass("fa-star-o"))}game.gridSize=parseInt(e)+2}}},gameBoard={dragged:null,dragStart:function(e){gameBoard.dragged=e.target.getAttribute("data-value")},dragEnter:function(e){e.target.style.opacity="0.5"},dragLeave:function(e){e.target.getAttribute("data-value")!=gameBoard.dragged&&(e.target.style.opacity="1")},dragOver:function(e){e.preventDefault()},dragEnd:function(e){e.target.style.opacity="1"},dragDrop:function(e){e.preventDefault(),e.target.style.opacity="1";var t=e.target.getAttribute("data-value"),a=$("[data-value="+t+"]"),r=$("[data-value="+gameBoard.dragged+"]"),i=parseInt(r.attr("pos")),n=parseInt(a.attr("pos"));if(n!==i){if(i==n-1)a.insertBefore(r);else if(n==i-1)r.insertBefore(a);else{var g;n==game.gridSize*game.gridSize-1?(g=a.prev(),a.insertBefore(r),r.insertAfter(g)):(g=a.next(),a.insertBefore(r),r.insertBefore(g))}a.attr("pos",i),r.attr("pos",n),judge.checkForWin()}},addDragDropHandlers:function(){$("#grid").children().on("dragstart",gameBoard.dragStart).on("dragenter",gameBoard.dragEnter).on("dragend",gameBoard.dragEnd).on("drop",gameBoard.dragDrop).on("dragleave",gameBoard.dragLeave).on("dragover",gameBoard.dragOver)},createGrid:function(e,t){for(var a=[],r=parseInt(400/e),i=parseInt(400/game.gridSize),n=parseInt(r/game.gridSize),g=0;g<game.gridSize*game.gridSize;g++){var o=Math.floor(g%game.gridSize*(100/(game.gridSize-1))),d=Math.floor(Math.floor(g/game.gridSize)*(100/(game.gridSize-1))),m=$("<li draggable='true' data-value="+g+"></li>").css({"background-image":"url("+t+")","background-size":100*game.gridSize+"%",width:i+"px",height:n+"px","background-position":o+"% "+d+"%"});a.push(m)}a.shuffle();for(var g=0;g<a.length;g++)a[g].attr("pos",g),$("#grid").append(a[g]);gameBoard.addDragDropHandlers()}},judge={winning_text:["You just worked wonders","Excellent! Keep it up","You Got it!","Well done! I thought you'd miss","Better late than never"],checkForWin:function(){var e=$("[data-value]").map(function(){return $(this).data("value")});if(judge.isSorted(e)){var t=timetracker.stopRunning(),a=timetracker.getTimerText(t)+"</br>"+judge.winning_text[judge.getMessageIndex(t)];game.end(a)}},getMessageIndex:function(e){var t,a=game.gridSize;return 3==a?t=30:4==a?t=60:5==a?t=90:6==a&&(t=120),Math.floor(e/t)+1},isSorted:function(e){for(var t=0;t<e.length-1;t++)if(!(e[t]<e[t+1]))return!1;return!0}};$(document).ready(function(){$("#category").change(game.setTheme),$("#start-btn").click(game.begin),$("#reset-btn").click(game.reset),$(".level").find("i").click(game.updateLevel)});var timetracker={startTime:null,timer:null,running:!1,start:function(){timetracker.startTime=new Date,timetracker.running=!0,timetracker.countTime()},countTime:function(){var e=new Date,t=e.getTime(),a=t-timetracker.startTime.getTime(),r=timetracker.getTimerText(parseInt(a/1e3));$("#timer").text(r),timetracker.timer=setTimeout(timetracker.countTime,500)},getTimerText:function(e){var t=Math.floor(e/3600),a=Math.floor(Math.floor(e-3600*t)/60),r=e%60;return t<10&&(t="0"+t.toString()),a<10&&(a="0"+a.toString()),r<10&&(r="0"+r.toString()),t+":"+a+":"+r},stopRunning:function(){clearTimeout(timetracker.timer),timetracker.running=!1;var e=new Date,t=e.getTime(),a=t-timetracker.startTime.getTime();return parseInt(a/1e3)}};Array.prototype.shuffle=function(){for(var e=this.length-1;e>=0;e--){var t=Math.floor(Math.random()*this.length),a=this[e];this[e]=this[t],this[t]=a}return this};